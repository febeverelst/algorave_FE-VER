---
import { recipes } from "../data/recipes";
import RecipeCard from "../components/RecipeCard.astro";

const {
    title,
    course,
    level,
    risk,
    goal,
    usedWhen,
    ingredients,
    moreInfo,
    slug,
} = Astro.props;

const getRandomRecipes = (count, excludeCourse, excludeSlug) => {
    const available = recipes.filter(
        (r) => r.course !== excludeCourse && r.slug !== excludeSlug,
    );
    const shuffled = available.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
};

const getCourseUrl = (course) => {
    const mapping = {
        Entr√©es: "/entrees",
        "Palate Cleansers": "/palate-cleansers",
        "Main Courses": "/main-courses",
        Sides: "/sides",
        Desserts: "/desserts",
    };
    return mapping[course] || `/tags/${encodeURIComponent(course)}`;
};
---

<article class="recipe">
    <div class="recipe-tags">
        <a href={getCourseUrl(course)} class="tag">{course}</a>
        <a href={`/tags/${encodeURIComponent(level)}`} class="tag">{level}</a>
        <a href={`/tags/${encodeURIComponent(risk)}`} class="tag">{risk}</a>
    </div>

    <h1>{title}</h1>
    <section class="recipe-intent">
        <div class="context">
            <div class="goal">
                <h2>Goal</h2>
                <p>{goal}</p>
            </div>
            <div>
                <h3>Used When</h3>
                <ul>
                    {usedWhen.map((item) => <li>{item}</li>)}
                </ul>
            </div>

            <div>
                <h3>Ingredients</h3>
                <ul>
                    {ingredients.map((item) => <li>{item}</li>)}
                </ul>
            </div>
        </div>
        <div class="recipe-method">
            <h2>Method</h2>
            <slot />
        </div>
    </section>

    <section class="more-and-related">
        {
            moreInfo && (
                <section class="more-info_container">
                    <h2>More Info</h2>

                    {moreInfo.description && (
                        <div>
                            {moreInfo.description.map((text) => (
                                <p>{text}</p>
                            ))}
                        </div>
                    )}

                    {moreInfo.tips && (
                        <div>
                            <h3>Tips</h3>
                            <ul>
                                {moreInfo.tips.map((tip) => (
                                    <li>{tip}</li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {moreInfo.warnings && (
                        <div>
                            <h3>Warnings</h3>
                            <ul>
                                {moreInfo.warnings.map((warn) => (
                                    <li>{warn}</li>
                                ))}
                            </ul>
                        </div>
                    )}
                </section>
            )
        }

        <section class="related-recipes">
            <h2>Other {course} Recipes</h2>
            <div class="recipe-grid">
                {
                    recipes
                        .filter((r) => r.course === course && r.slug !== slug)
                        .map((recipe) => (
                            <RecipeCard
                                title={recipe.title}
                                level={recipe.level}
                                slug={recipe.slug}
                                course={recipe.course}
                            />
                        ))
                }
            </div>
            <h2>Recommended Recipes</h2>
            <div class="recipe-grid">
                {
                    getRandomRecipes(2, course, slug).map((recipe) => (
                        <RecipeCard
                            title={recipe.title}
                            level={recipe.level}
                            slug={recipe.slug}
                            course={recipe.course}
                        />
                    ))
                }
            </div>
        </section>
    </section>
</article>
